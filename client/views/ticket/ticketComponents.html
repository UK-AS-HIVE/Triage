<template name="ticketChangelogItem">
{{#if note}}
<div class="row">
  <div class="col-xs-4 col-md-2">
    <label for="note-{{_id}}" class="control-label pull-right">
      {{#if authorId}}
        {{> userPortrait userId=authorId class="user-image"}}
      {{else}}
        {{authorEmail}} (via e-mail)
      {{/if}}
      <small style="font-size: 0.7em; font-weight: lighter;">{{>timeFromNow date=timestamp}}</small>
    </label>
  </div>
  <div class="col-xs-8 col-md-10">
    <div class="well well-sm note-well" style="text-align: left;">{{linkify message}}</div>
  </div>
</div>
{{else}}
<div class="row">
  <div class="col-xs-8 col-xs-offset-4 col-md-10 col-md-offset-2">
    {{#if changeIsType 'attachment'}}
      {{#with otherId}}
        {{#if file.thumbnail}}
          <img class="img-thumbnail" style="max-width: 100%; max-height: 128px" src="/file/{{file.thumbnail}}"/><br/>
        {{/if}}
      {{/with}}
    {{/if}}
    <small style="font-size: 0.7em;">
      {{#if changeIsType 'attachment'}}
        {{#if oldValue}}
          User {{authorName}} removed attached file {{oldValue}}
        {{/if}}
        {{#if newValue}}
          User {{authorName}} attached file {{newValue}}
        {{/if}}
      {{/if}}
      {{#if changeIsType 'field'}}
        {{#if fieldIs 'status'}}
          User {{authorName}} changed status from {{oldValue}} to {{newValue}}
        {{/if}}

        {{#if fieldIs 'tags'}}
          {{#if oldValue}}
            User {{authorName}} removed tag(s) {{oldValue}}
          {{/if}}
          {{#if newValue}}
            User {{authorName}} added tag(s) {{newValue}}
          {{/if}}
        {{/if}}

        {{#if fieldIs 'associatedUserIds'}}
          {{#if oldValue}}
            User {{authorName}} removed associated user(s) {{oldValue}}
          {{/if}}
          {{#if newValue}}
            User {{authorName}} associated user(s) {{newValue}}
          {{/if}}
        {{/if}}
      {{/if}}
       @ {{timestamp}}
    </small>
  </div>
</div>
{{/if}}
</template>

<template name="ticketInfoTable">
<div class="row">
  <table class="table table-bordered">
    <thead>
      <tr>
        <th width="33%">Assigned Users</th>
        <th width="33%">Tags</th>
        <th width="33%">Attachments</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          {{#if admin}}
          <div class="assign-user-field">
            <span class="icon glyphicon glyphicon-plus"></span>
            {{>inputAutocomplete settings=userSettings name="assignUser" placeholder="Assign User" data-toggle="tooltip" data-trigger="manual" title="User not found."}}
          </div>
          {{/if}}
          {{#each associatedUserIds}}
          {{> userPortrait userId=this associated=true class="user-image"}}
          {{/each}}
        </td>
        <td>
          {{#if admin}}
          <div class="add-tag-field">
            <span class="icon glyphicon glyphicon-plus"></span>
            {{>inputAutocomplete settings=tagSettings name="addTag" placeholder="Add a tag"}}
          </div> 
            {{#each tags}}
              {{> ticketTag}}
            {{/each}}
          {{else}}
            {{#each tags}}
              {{this}}
            {{/each}}
          {{/if}}
        </td>
        <td>
          <div class="btn-group">
            <button type="button" class="add-attachment-btn btn dropdown-toggle" data-toggle="dropdown" aria-expanded="False">
              <span class="icon glyphicon glyphicon-plus"></span>
            </button>

            <ul class="dropdown-menu" data-toggle="dropdown">
              <li><a data-action="uploadFile">Upload File</a></li>
              {{#if isCordova}}<li><a href="#">Take Picture</a></li>{{/if}}
            </ul>
          </div>

          {{#each attachmentIds}}
            <div class="attachment">
              <div class="attachment-link">
              {{#if file.thumbnail}}
                <img class="img-thumbnail" style="max-width: 64px; max-height:24px;" src="/file/{{file.thumbnail}}" />
              {{/if}}
                <a data-action="downloadAttachment" href="/file/{{file.filenameOnDisk}}" target="_blank">{{file.filename}}</a><br />
              </div>
              <div class="remove-attachment">
                <a href="#" data-action="removeAttachment">Remove</a>
              </div>
            </div>
          {{/each}}
        </td>
      </tr>
    </tbody>
  </table>
</div>
</template>

<template name="ticketNoteInput">
<div class="form-group">
  <div class="col-xs-12 col-md-10 col-md-offset-2">
    <div class="input-group">
      {{#if admin}}
        {{> inputAutocomplete name="newNoteAdmin" class="form-control" placeholder="Add a new note..." settings=settings data-ticket=_id }}
      {{else}}
        <input class="form-control" placeholder="Add a new note..." name="newNote" data-ticket="{{_id}}">
      {{/if}}
      <div class="input-group-btn">
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="False">Attach File <span class="caret"></span></button>
        <ul class="dropdown-menu" role="menu">
          <li><a data-action="uploadFile">Upload File</a></li>
          {{#if isCordova}}<li><a href="#">Take Picture</a></li>{{/if}}
        </ul>
      </div>
    </div>
  </div>
</div>
</template>

<template name="ticketTag">
<div class="tag">
  <div class="tag-link">
    <a href="#" data-action="addTagFilter">{{this}}</a>
  </div>
  <div class="remove-tag">
    <a href="#" data-action="removeTag">Remove</a>
  </div>
</div>
</template>

<template name="ticketHeading">
<div class="col-md-4 col-xs-8">
  <div class="col-xs-4 col-md-4">
    {{>userPortrait userId=this.authorId class="user-image"}}
  </div>
  <div class="col-xs-8 col-md-8">
    <strong>
      {{author.displayName}}<br>
      {{author.department}}<br>
      {{author.physicalDeliveryOfficeName}}<br>
    </strong>
  </div>
</div>
<div class="col-md-4 col-md-offset-4 col-xs-4" style="text-align: right; float: right;">
  <a href="/ticket/{{ticketNumber}}">#{{ticketNumber}}</a><br>
  <strong>{{queueName}}</strong><br>
  {{>timestampFormatter date=submittedTimestamp}}<br>
  {{>timeFromNow date=submittedTimestamp}}
</div>
</template>

<template name="removeAttachmentModal">
  <div class="modal fade in" id="removeAttachmentModal" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Remove Attachment</h4>
        </div>
        <div class="modal-body">
          Are you sure you want to remove attachment <strong>{{attachment.filename}}</strong> from ticket <strong>#{{ticket.ticketNumber}}</strong>? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button class="btn btn-default pull-left" data-dismiss="modal">Cancel</button>
          <button class="btn btn-danger pull-right" data-action="removeAttachment">Confirm</button>
        </div>
      </div>
    </div>
  </div>
</template>
